import{UnsignedByteType as e,RGBAFormat as t,UnsignedShort565Type as n,RGBFormat as r,LuminanceAlphaFormat as a,HalfFloatType as i,RGBA_S3TC_DXT1_Format as o,RGBA_S3TC_DXT5_Format as s,RGB_ETC1_Format as u,RGBA_ASTC_4x4_Format as l,RGB_PVRTC_4BPPV1_Format as c,Object3D as f,MeshBasicMaterial as m,Box3 as d,Vector3 as h,TangentSpaceNormalMap as p,Mesh as b,Loader as y,Matrix4 as v,CompressedTexture as g,DataTexture as w,LinearFilter as S,sRGBEncoding as C,LinearEncoding as T,BufferGeometry as A,Sphere as U,Float32BufferAttribute as _}from"three";function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function B(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}(e,t)||R(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function L(e){return function(e){if(Array.isArray(e))return M(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||R(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(e,t){if(e){if("string"==typeof e)return M(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?M(e,t):void 0}}function M(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function P(e){return(P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function G(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var z,I,D,k,O,N,W,j,V,q,X,H,Q,Y,Z,K,J,$,ee,te,ne,re,ae,ie,oe=(z="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e){var t;e=e||{},t||(t=void 0!==e?e:{});var n,r={};for(n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);t.arguments=[],t.thisProgram="./this.program",t.quit=function(e,t){throw t},t.preRun=[],t.postRun=[];var a="";document.currentScript&&(a=document.currentScript.src),z&&(a=z),a=0!==a.indexOf("blob:")?a.substr(0,a.lastIndexOf("/")+1):"";var i=t.print||("undefined"!=typeof console?console.log.bind(console):"undefined"!=typeof print?print:null),o=t.printErr||("undefined"!=typeof printErr?printErr:"undefined"!=typeof console&&console.warn.bind(console)||i);for(n in r)r.hasOwnProperty(n)&&(t[n]=r[n]);function s(e){var t=S[M>>2];return(e=t+e+15&-16)>wt()&&Vt(),S[M>>2]=e,t}r=void 0;var u,l={"f64-rem":function(e,t){return e%t},debugger:function(){}};"object"!==("undefined"==typeof WebAssembly?"undefined":P(WebAssembly))&&o("no native wasm support detected");var c,f=!1;function m(e,t){e||Vt("Assertion failed: "+t)}function d(e){var n=t["_"+e];return m(n,"Cannot call unknown function "+e+", make sure it is exported"),n}function h(e,t,n,r){var a={string:function(e){var t=0;if(null!=e&&0!==e){var n=1+(e.length<<2);t=It(n),x(e,v,t,n)}return t},array:function(e){var t=It(e.length);return y.set(e,t),t}},i=d(e),o=[];if(e=0,r)for(var s=0;s<r.length;s++){var u=a[n[s]];u?(0===e&&(e=kt()),o[s]=u(r[s])):o[s]=r[s]}return n=function(e){return"string"===t?E(e):"boolean"===t?!!e:e}(n=i.apply(null,o)),0!==e&&Dt(e),n}function p(e){if("number"==typeof e)var t=!0,n=e;else t=!1,n=e.length;var r=Gt(Math.max(n,1));if(t){for(e=r,m(0==(3&r)),t=r+(-4&n);e<t;e+=4)S[e>>2]=0;for(t=r+n;e<t;)y[e++>>0]=0;return r}return e.subarray||e.slice?v.set(e,r):v.set(new Uint8Array(e),r),r}var b,y,v,g,w,S,C,T,A,U="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function _(e,t,n){var r=t+n;for(n=t;e[n]&&!(n>=r);)++n;if(16<n-t&&e.subarray&&U)return U.decode(e.subarray(t,n));for(r="";t<n;){var a=e[t++];if(128&a){var i=63&e[t++];if(192==(224&a))r+=String.fromCharCode((31&a)<<6|i);else{var o=63&e[t++];65536>(a=224==(240&a)?(15&a)<<12|i<<6|o:(7&a)<<18|i<<12|o<<6|63&e[t++])?r+=String.fromCharCode(a):(a-=65536,r+=String.fromCharCode(55296|a>>10,56320|1023&a))}}else r+=String.fromCharCode(a)}return r}function E(e){return e?_(v,e,void 0):""}function x(e,t,n,r){if(0<r){r=n+r-1;for(var a=0;a<e.length;++a){var i=e.charCodeAt(a);if(55296<=i&&57343>=i&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++a)),127>=i){if(n>=r)break;t[n++]=i}else{if(2047>=i){if(n+1>=r)break;t[n++]=192|i>>6}else{if(65535>=i){if(n+2>=r)break;t[n++]=224|i>>12}else{if(n+3>=r)break;t[n++]=240|i>>18,t[n++]=128|i>>12&63}t[n++]=128|i>>6&63}t[n++]=128|63&i}}t[n]=0}}function B(e){for(var t=0,n=0;n<e.length;++n){var r=e.charCodeAt(n);55296<=r&&57343>=r&&(r=65536+((1023&r)<<10)|1023&e.charCodeAt(++n)),127>=r?++t:t=2047>=r?t+2:65535>=r?t+3:t+4}return t}function L(e){return 0<e%65536&&(e+=65536-e%65536),e}function R(){t.HEAP8=y=new Int8Array(b),t.HEAP16=g=new Int16Array(b),t.HEAP32=S=new Int32Array(b),t.HEAPU8=v=new Uint8Array(b),t.HEAPU16=w=new Uint16Array(b),t.HEAPU32=C=new Uint32Array(b),t.HEAPF32=T=new Float32Array(b),t.HEAPF64=A=new Float64Array(b)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");var M=17120,F=t.TOTAL_MEMORY||134217728;function G(e){for(;0<e.length;){var n=e.shift();if("function"==typeof n)n();else{var r=n.Vb;"number"==typeof r?void 0===n.Sb?t.dynCall_v(r):t.dynCall_vi(r,n.Sb):r(void 0===n.Sb?null:n.Sb)}}}5242880>F&&o("TOTAL_MEMORY should be larger than TOTAL_STACK, was "+F+"! (TOTAL_STACK=5242880)"),(c=t.wasmMemory?t.wasmMemory:new WebAssembly.Memory({initial:F/65536}))&&(b=c.buffer),F=b.byteLength,R(),S[M>>2]=5260032;var I=[],D=[],k=[],O=[],N=[],W=!1;function j(){var e=t.preRun.shift();I.unshift(e)}var V=0,q=null;function X(){var e=H;return String.prototype.startsWith?e.startsWith("data:application/octet-stream;base64,"):0===e.indexOf("data:application/octet-stream;base64,")}t.preloadedImages={},t.preloadedAudios={};var H="umbra.wasm";if(!X()){var Q=H;H=t.locateFile?t.locateFile(Q,a):a+Q}function Y(){try{if(t.wasmBinary)return new Uint8Array(t.wasmBinary);throw"both async and sync fetching of the wasm failed"}catch(e){Vt(e)}}function Z(e){function n(e){t.asm=e.exports,V--,t.monitorRunDependencies&&t.monitorRunDependencies(V),0==V&&q&&(e=q,q=null,e())}function r(e){n(e.instance)}function a(e){return(t.wasmBinary||"function"!=typeof fetch?new Promise((function(e){e(Y())})):fetch(H,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+H+"'";return e.arrayBuffer()})).catch((function(){return Y()}))).then((function(e){return WebAssembly.instantiate(e,i)})).then(e,(function(e){o("failed to asynchronously prepare wasm: "+e),Vt(e)}))}var i={env:e,global:{NaN:NaN,Infinity:1/0},"global.Math":Math,asm2wasm:l};if(V++,t.monitorRunDependencies&&t.monitorRunDependencies(V),t.instantiateWasm)try{return t.instantiateWasm(i,n)}catch(e){return o("Module.instantiateWasm callback failed with error: "+e),!1}return function(){if(t.wasmBinary||"function"!=typeof WebAssembly.instantiateStreaming||X()||"function"!=typeof fetch)return a(r);fetch(H,{credentials:"same-origin"}).then((function(e){return WebAssembly.instantiateStreaming(e,i).then(r,(function(e){o("wasm streaming compile failed: "+e),o("falling back to ArrayBuffer instantiation"),a(r)}))}))}(),{}}t.asm=function(e,t){return t.memory=c,t.table=new WebAssembly.Table({initial:357,maximum:357,element:"anyfunc"}),t.__memory_base=1024,t.__table_base=0,Z(t)};var K=[function(){alert("Invalid http method.")},function(e,n,r,a,i,o,s,u,l,c,f){return function(e,n,r,a,i,o,s,u,l,c,f){var m=E(e);n=E(n),o=E(o);var d=new XMLHttpRequest;d.open(n,m,!0),("GET"!=n||0!=o.length)&&(d.withCredentials=!0),d.responseType="arraybuffer";var h=function(){var e=gt;return gt++,e}();if(d.onload=function(){if(200==d.status){var n=new Uint8Array(d.response),o=t.URLsDownloaded;t.maxBytesDownloaded+=d.response.byteLength,o.has(e)||(o.add(e),t.minBytesDownloaded+=d.response.byteLength),c?n.length!=f?t.dynCall_viii(i,h,r,0):(v.set(n,c),t.dynCall_viiii(a,h,r,null,0)):(o=Gt(n.length),v.set(n,o),t.dynCall_viiii(a,h,r,o,n.length),Ft(o))}else t.dynCall_viii(i,h,r,d.status);delete vt[h]},d.onerror=function(){t.dynCall_viii(i,h,r,d.status),delete vt[h]},d.onabort=function(){delete vt[h]},0!=o.length&&d.setRequestHeader("Authorization","Basic "+btoa(o+":")),2<=(l=E(l).split("\n")).length)for(m=0;m<l.length;m+=2)d.setRequestHeader(l[m],l[m+1]);return"POST"==n?d.send(y.slice(s,s+u)):d.send(null),vt[h]=d,h}(e,n,r,a,i,o,s,u,l,c,f)},function(){alert("Uploads are not supported.")}];D.push({Vb:function(){zt()}});var J={};function $(e,t){O.unshift({Vb:e,Sb:t})}var ee=[null,[],[]];function te(e,t){var n=ee[e];0===t||10===t?((1===e?i:o)(_(n,0)),n.length=0):n.push(t)}var ne=0;function re(){return S[(ne+=4)-4>>2]}var ae={},ie={};function oe(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function se(e){return this.fromWireType(C[e>>2])}var ue={},le={},ce={};function fe(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return 48<=t&&57>=t?"_"+e:e}function me(e,t){return e=fe(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function de(e){var t=Error,n=me(e,(function(t){this.name=e,this.message=t,void 0!==(t=Error(t).stack)&&(this.stack=this.toString()+"\n"+t.replace(/^Error(:[^\n]*)?\n/,""))}));return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},n}var he=void 0;function pe(e,t,n){function r(t){if((t=n(t)).length!==e.length)throw new he("Mismatched type converter count");for(var r=0;r<e.length;++r)Se(e[r],t[r])}e.forEach((function(e){ce[e]=t}));var a=Array(t.length),i=[],o=0;t.forEach((function(e,t){le.hasOwnProperty(e)?a[t]=le[e]:(i.push(e),ue.hasOwnProperty(e)||(ue[e]=[]),ue[e].push((function(){a[t]=le[e],++o===i.length&&r(a)})))})),0===i.length&&r(a)}function be(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var ye=void 0;function ve(e){for(var t="";v[e];)t+=ye[v[e++]];return t}var ge=void 0;function we(e){throw new ge(e)}function Se(e,t,n){if(n=n||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||we('type "'+r+'" must have a positive integer typeid pointer'),le.hasOwnProperty(e)){if(n.gc)return;we("Cannot register type '"+r+"' twice")}le[e]=t,delete ce[e],ue.hasOwnProperty(e)&&(t=ue[e],delete ue[e],t.forEach((function(e){e()})))}var Ce=[],Te=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Ae(e){4<e&&0==--Te[e].Wb&&(Te[e]=void 0,Ce.push(e))}function Ue(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Ce.length?Ce.pop():Te.length;return Te[t]={Wb:1,value:e},t}}function _e(e){if(null===e)return"null";var t=P(e);return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Ee(e,t){switch(t){case 2:return function(e){return this.fromWireType(T[e>>2])};case 3:return function(e){return this.fromWireType(A[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function xe(e){var t=Function;if(!(t instanceof Function))throw new TypeError("new_ called with constructor type "+P(t)+" which is not a function");var n=me(t.name||"unknownFunctionName",(function(){}));return n.prototype=t.prototype,n=new n,(e=t.apply(n,e))instanceof Object?e:n}function Be(e,n,r){t.hasOwnProperty(e)?((void 0===r||void 0!==t[e].Qb&&void 0!==t[e].Qb[r])&&we("Cannot register public name '"+e+"' twice"),function(e,n){var r=t;if(void 0===r[e].Qb){var a=r[e];r[e]=function(){return r[e].Qb.hasOwnProperty(arguments.length)||we("Function '"+n+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+r[e].Qb+")!"),r[e].Qb[arguments.length].apply(this,arguments)},r[e].Qb=[],r[e].Qb[a.$b]=a}}(e,e),t.hasOwnProperty(r)&&we("Cannot register multiple overloads of a function with the same number of arguments ("+r+")!"),t[e].Qb[r]=n):(t[e]=n,void 0!==r&&(t[e].zc=r))}function Le(e,n){if(e=ve(e),void 0!==t["FUNCTION_TABLE_"+e])var r=t["FUNCTION_TABLE_"+e][n];else if("undefined"!=typeof FUNCTION_TABLE)r=FUNCTION_TABLE[n];else{void 0===(r=t["dynCall_"+e])&&void 0===(r=t["dynCall_"+e.replace(/f/g,"d")])&&we("No dynCall invoker for signature: "+e);for(var a=[],i=1;i<e.length;++i)a.push("a"+i);i="return function dynCall_"+e+"_"+n+"("+a.join(", ")+") {\n",i+="    return dynCall(rawFunction"+(a.length?", ":"")+a.join(", ")+");\n",r=new Function("dynCall","rawFunction",i+"};\n")(r,n)}return"function"!=typeof r&&we("unknown function pointer with signature "+e+": "+n),r}var Re=void 0;function Me(e){var t=ve(e=Lt(e));return Ft(e),t}function Pe(e,t,n){switch(t){case 0:return n?function(e){return y[e]}:function(e){return v[e]};case 1:return n?function(e){return g[e>>1]}:function(e){return w[e>>1]};case 2:return n?function(e){return S[e>>2]}:function(e){return C[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Fe(e){return e||we("Cannot use deleted val. handle = "+e),Te[e].value}function Ge(e,t){var n=le[e];return void 0===n&&we(t+" has unknown type "+Me(e)),n}var ze={};function Ie(e){var t=ze[e];return void 0===t?ve(e):t}var De=[];function ke(){Vt()}var Oe,Ne,We=null,je="",Ve=0,qe=null,Xe=0,He=0,Qe=0,Ye=0,Ze=[],Ke={},Je=!1,$e=!1,et=[];function tt(){function e(){$e=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas||document.msPointerLockElement===t.canvas}if(t.preloadPlugins||(t.preloadPlugins=[]),!ht){ht=!0;try{pt=!0}catch(e){pt=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}bt="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:pt?null:console.log("warning: no BlobBuilder"),yt="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,t.Zb||void 0!==yt||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),t.Zb=!0),t.preloadPlugins.push({canHandle:function(e){return!t.Zb&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},handle:function(e,n,r,a){var i=null;if(pt)try{(i=new Blob([e],{type:ct(n)})).size!==e.length&&(i=new Blob([new Uint8Array(e).buffer],{type:ct(n)}))}catch(e){!function(e){u||(u={}),u[e]||(u[e]=1,o(e))}("Blob constructor present but fails: "+e+"; falling back to blob builder")}i||((i=new bt).append(new Uint8Array(e).buffer),i=i.getBlob());var s=yt.createObjectURL(i),l=new Image;l.onload=function(){m(l.complete,"Image "+n+" could not be decoded");var a=document.createElement("canvas");a.width=l.width,a.height=l.height,a.getContext("2d").drawImage(l,0,0),t.preloadedImages[n]=a,yt.revokeObjectURL(s),r&&r(e)},l.onerror=function(){console.log("Image "+s+" could not be decoded"),a&&a()},l.src=s}}),t.preloadPlugins.push({canHandle:function(e){return!t.yc&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(e,n,r,a){function i(a){s||(s=!0,t.preloadedAudios[n]=a,r&&r(e))}function o(){s||(s=!0,t.preloadedAudios[n]=new Audio,a&&a())}var s=!1;if(!pt)return o();try{var u=new Blob([e],{type:ct(n)})}catch(e){return o()}u=yt.createObjectURL(u);var l=new Audio;l.addEventListener("canplaythrough",(function(){i(l)}),!1),l.onerror=function(){if(!s){console.log("warning: browser could not fully decode audio "+n+", trying slower base64 approach");for(var t="",r=0,a=0,o=0;o<e.length;o++)for(r=r<<8|e[o],a+=8;6<=a;){var u=r>>a-6&63;a-=6,t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[u]}2==a?(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&r)<<4],t+="=="):4==a&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&r)<<2],t+="="),l.src="data:audio/x-"+n.substr(-3)+";base64,"+t,i(l)}},l.src=u,function(e){t.noExitRuntime=!0,setTimeout((function(){f||e()}),1e4)}((function(){i(l)}))}});var n=t.canvas;n&&(n.requestPointerLock=n.requestPointerLock||n.mozRequestPointerLock||n.webkitRequestPointerLock||n.msRequestPointerLock||function(){},n.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},n.exitPointerLock=n.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("mspointerlockchange",e,!1),t.elementPointerLock&&n.addEventListener("click",(function(e){!$e&&t.canvas.requestPointerLock&&(t.canvas.requestPointerLock(),e.preventDefault())}),!1))}}var nt=!1,rt=void 0,at=void 0;function it(e,n,r){function a(){Je=!1;var e=i.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e?(i.exitFullscreen=st,rt&&i.requestPointerLock(),Je=!0,at?("undefined"!=typeof SDL&&(S[SDL.screen>>2]=8388608|C[SDL.screen>>2]),dt(t.canvas),mt()):dt(i)):(e.parentNode.insertBefore(i,e),e.parentNode.removeChild(e),at?("undefined"!=typeof SDL&&(S[SDL.screen>>2]=-8388609&C[SDL.screen>>2]),dt(t.canvas),mt()):dt(i)),t.onFullScreen&&t.onFullScreen(Je),t.onFullscreen&&t.onFullscreen(Je)}void 0===(rt=e)&&(rt=!0),void 0===(at=n)&&(at=!1);var i=t.canvas;nt||(nt=!0,document.addEventListener("fullscreenchange",a,!1),document.addEventListener("mozfullscreenchange",a,!1),document.addEventListener("webkitfullscreenchange",a,!1),document.addEventListener("MSFullscreenChange",a,!1));var o=document.createElement("div");i.parentNode.insertBefore(o,i),o.appendChild(i),o.requestFullscreen=o.requestFullscreen||o.mozRequestFullScreen||o.msRequestFullscreen||(o.webkitRequestFullscreen?function(){o.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}:null)||(o.webkitRequestFullScreen?function(){o.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),r?o.requestFullscreen({Bc:r}):o.requestFullscreen()}function ot(e,t,n){o("Browser.requestFullScreen() is deprecated. Please call Browser.requestFullscreen instead."),ot=function(e,t,n){it(e,t,n)},it(e,t,n)}function st(){return!!Je&&((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0)}var ut=0;function lt(e){if("function"==typeof requestAnimationFrame)requestAnimationFrame(e);else{var t=Date.now();if(0===ut)ut=t+1e3/60;else for(;t+2>=ut;)ut+=1e3/60;setTimeout(e,Math.max(ut-t,0))}}function ct(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]}var ft=[];function mt(){var e=t.canvas;ft.forEach((function(t){t(e.width,e.height)}))}function dt(e,n,r){n&&r?(e.oc=n,e.fc=r):(n=e.oc,r=e.fc);var a=n,i=r;if(t.forcedAspectRatio&&0<t.forcedAspectRatio&&(a/i<t.forcedAspectRatio?a=Math.round(i*t.forcedAspectRatio):i=Math.round(a/t.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var o=Math.min(screen.width/a,screen.height/i);a=Math.round(a*o),i=Math.round(i*o)}at?(e.width!=a&&(e.width=a),e.height!=i&&(e.height=i),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=n&&(e.width=n),e.height!=r&&(e.height=r),void 0!==e.style&&(a!=n||i!=r?(e.style.setProperty("width",a+"px","important"),e.style.setProperty("height",i+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))}var ht,pt,bt,yt,vt={},gt=0;function wt(){return y.length}var St,Ct={};function Tt(e,t){var n=Ct[e];if(n)t(null,n);else{try{var r=function(){if("undefined"!=typeof indexedDB)return indexedDB;var e=null;return"object"===("undefined"==typeof window?"undefined":P(window))&&(e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),m(e,"IDBStore used, but indexedDB not supported"),e}().open(e,22)}catch(e){return void t(e)}r.onupgradeneeded=function(e){var t=e.target.result;e=e.target.transaction,t.objectStoreNames.contains("FILE_DATA")?e.objectStore("FILE_DATA"):t.createObjectStore("FILE_DATA")},r.onsuccess=function(){n=r.result,Ct[e]=n,t(null,n)},r.onerror=function(e){t(this.error),e.preventDefault()}}}function At(e,t,n){Tt(e,(function(e,r){if(e)return n(e);(e=r.transaction(["FILE_DATA"],t)).onerror=function(e){n(this.error||"unknown error"),e.preventDefault()},e=e.objectStore("FILE_DATA"),n(null,e)}))}function Ut(e){!t.noExitRuntime&&(f=!0,G(O),t.onExit)&&t.onExit(e),t.quit(e,new Wt(e))}t._exit=Ut,x("GMT",v,17024,4),O.push((function(){var e=t._fflush;e&&e(0),ee[1].length&&te(1,10),ee[2].length&&te(2,10)})),he=t.InternalError=de("InternalError");for(var _t=Array(256),Et=0;256>Et;++Et)_t[Et]=String.fromCharCode(Et);function xt(e){var t=Array(B(e)+1);return x(e,t,0,t.length),t}ye=_t,ge=t.BindingError=de("BindingError"),t.count_emval_handles=function(){for(var e=0,t=5;t<Te.length;++t)void 0!==Te[t]&&++e;return e},t.get_first_emval=function(){for(var e=5;e<Te.length;++e)if(void 0!==Te[e])return Te[e];return null},Re=t.UnboundTypeError=de("UnboundTypeError"),t.requestFullScreen=function(e,n,r){o("Module.requestFullScreen is deprecated. Please call Module.requestFullscreen instead."),t.requestFullScreen=t.requestFullscreen,ot(e,n,r)},t.requestFullscreen=function(e,t,n){it(e,t,n)},t.requestAnimationFrame=function(e){lt(e)},t.setCanvasSize=function(e,n,r){dt(t.canvas,e,n),r||mt()},t.pauseMainLoop=function(){We=null,Ve++},t.resumeMainLoop=function(){Ve++;var e=He,n=Qe,r=qe;qe=null,function(e){var n=Xe;t.noExitRuntime=!0,m(!qe,"emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),qe=e,Xe=n;var r=void 0!==n?function(){t.dynCall_vi(e,n)}:function(){t.dynCall_v(e)},a=Ve;Ne=function(){if(!f)if(0<Ze.length){var e,n=Date.now(),i=Ze.shift();i.Vb(i.Sb),console.log('main loop blocker "'+i.name+'" took '+(Date.now()-n)+" ms"),t.setStatus&&(n=t.statusMessage||"Please wait...",i=void 0,e=Ke.uc,i?i<e?t.setStatus(n+" ("+(e-i)+"/"+e+")"):t.setStatus(n):t.setStatus("")),a<Ve||setTimeout(Ne,0)}else if(!(a<Ve))if(Ye=Ye+1|0,1==He&&1<Qe&&0!=Ye%Qe)We();else{0==He&&(Oe=ke()),"timeout"===je&&t.Ub&&(o("Looks like you are rendering without using requestAnimationFrame for the main loop. You should use 0 for the frame rate in emscripten_set_main_loop in order to use requestAnimationFrame, as that can greatly improve your frame rates!"),je="");e:if(!(f||t.preMainLoop&&!1===t.preMainLoop())){try{r()}catch(e){if(e instanceof Wt)break e;throw e&&"object"===P(e)&&e.stack&&o("exception thrown: "+[e,e.stack]),e}t.postMainLoop&&t.postMainLoop()}a<Ve||("object"===("undefined"==typeof SDL?"undefined":P(SDL))&&SDL.audio&&SDL.audio.ic&&SDL.audio.ic(),We())}}}(r),function(e,t){if(He=e,Qe=t,qe)if(0==e)We=function(){var e=0|Math.max(0,Oe+t-ke());setTimeout(Ne,e)},je="timeout";else if(1==e)We=function(){lt(Ne)},je="rAF";else if(2==e){if("undefined"==typeof setImmediate){var n=[];addEventListener("message",(function(e){"setimmediate"!==e.data&&"setimmediate"!==e.data.target||(e.stopPropagation(),n.shift()())}),!0),setImmediate=function(e){n.push(e),postMessage("setimmediate","*")}}We=function(){setImmediate(Ne)},je="immediate"}}(e,n),We()},t.getUserMedia=function(){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(void 0)},t.createContext=function(e,n,r,a){return function(e,n,r,a){if(n&&t.Ub&&e==t.canvas)return t.Ub;var i;if(n){var o={antialias:!1,alpha:!1,wc:1};if(a)for(var s in a)o[s]=a[s];if("undefined"!=typeof GL&&(i=GL.rc(e,o)))var u=GL.getContext(i).pc}else u=e.getContext("2d");return u?(r&&(n||m("undefined"==typeof GLctx,"cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),t.Ub=u,n&&GL.xc(i),t.Ac=n,et.forEach((function(e){e()})),tt()),u):null}(e,n,r,a)},ke="undefined"!=typeof dateNow?dateNow:"object"===("undefined"==typeof performance?"undefined":P(performance))&&performance&&"function"==typeof performance.now?function(){return performance.now()}:Date.now;var Bt=t.asm({},{k:Vt,y:function(){},fa:function(){o("missing function: _ZN5Umbra13MiniSceneCopy7connectERK20UmbraSceneCopySource"),Vt(-1)},ba:function(){o("missing function: _ZN5Umbra13MiniSceneCopy9getStatusEPf"),Vt(-1)},C:function(){o("missing function: _ZN5Umbra13MiniSceneCopyC1ERNS_11MiniRuntimeERK25UmbraSceneCopyDestinationPK20UmbraEnvironmentInfoRKN5Eigen6MatrixIfLi3ELi1ELi0ELi3ELi1EEEfi"),Vt(-1)},Z:function e(n){if(e.ac)var r=S[n>>2],a=S[r>>2];else e.ac=!0,J.USER=J.LOGNAME="web_user",J.PATH="/",J.PWD="/",J.HOME="/home/web_user",J.LANG="C.UTF-8",J.LANG=("object"===("undefined"==typeof navigator?"undefined":P(navigator))&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",J._=t.thisProgram,a=W?Gt(1024):s(1024),r=W?Gt(256):s(256),S[r>>2]=a,S[n>>2]=r;n=[];var i,o=0;for(i in J)if("string"==typeof J[i]){var u=i+"="+J[i];n.push(u),o+=u.length}if(1024<o)throw Error("Environment size exceeded TOTAL_ENV_SIZE!");for(i=0;i<n.length;i++){o=u=n[i];for(var l=a,c=0;c<o.length;++c)y[l++>>0]=o.charCodeAt(c);y[l>>0]=0,S[r+4*i>>2]=a,a+=u.length+1}S[r+4*n.length>>2]=0},U:function(){return $.apply(null,arguments)},v:function(){},x:function(e){return t.___errno_location&&(S[t.___errno_location()>>2]=e),e},M:function(e,t){ne=t;try{return ae.Yb(),re(),re(),re(),re(),0}catch(e){return Vt(e),-e.Tb}},L:function(e,t){ne=t;try{var n=ae.Yb(),r=re(),a=re();return ae.sc(n,r,a)}catch(e){return Vt(e),-e.Tb}},K:function(e,t){ne=t;try{var n=re(),r=re(),a=re();for(t=e=0;t<a;t++){for(var i=S[r+8*t>>2],o=S[r+(8*t+4)>>2],s=0;s<o;s++)te(n,v[i+s]);e+=o}return e}catch(e){return Vt(e),-e.Tb}},ea:function(e,t){ne=t;try{var n=E(re()),r=re();return ae.tc((void 0).stat,n,r)}catch(e){return Vt(e),-e.Tb}},J:function(e,t){return ne=t,0},da:function(e,t){ne=t;try{var n=E(re()),r=re(),a=re();return(void 0).open(n,r,a).vc}catch(e){return Vt(e),-e.Tb}},I:function(e,t){return ne=t,0},H:function(e,t){ne=t;try{return ae.Yb(),0}catch(e){return Vt(e),-e.Tb}},w:function(){},G:function(e){var t=ie[e];delete ie[e];var n=t.jc,r=t.kc,a=t.Xb;pe([e],a.map((function(e){return e.ec})).concat(a.map((function(e){return e.mc}))),(function(e){var i={};return a.forEach((function(t,n){var r=e[n],o=t.cc,s=t.dc,u=e[n+a.length],l=t.lc,c=t.nc;i[t.bc]={read:function(e){return r.fromWireType(o(s,e))},write:function(e,t){var n=[];l(c,e,u.toWireType(n,t)),oe(n)}}})),[{name:t.name,fromWireType:function(e){var t,n={};for(t in i)n[t]=i[t].read(e);return r(e),n},toWireType:function(e,t){for(var a in i)if(!(a in t))throw new TypeError("Missing field");var o=n();for(a in i)i[a].write(o,t[a]);return null!==e&&e.push(r,o),o},argPackAdvance:8,readValueFromPointer:se,Rb:r}]}))},ca:function(e,t,n,r,a){var i=be(n);Se(e,{name:t=ve(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:a},argPackAdvance:8,readValueFromPointer:function(e){if(1===n)var r=y;else if(2===n)r=g;else{if(4!==n)throw new TypeError("Unknown boolean type size: "+t);r=S}return this.fromWireType(r[e>>i])},Rb:null})},p:function(e,n,r){e=ve(e),pe([],[n],(function(n){return n=n[0],t[e]=n.fromWireType(r),[]}))},aa:function(e,t){Se(e,{name:t=ve(t),fromWireType:function(e){var t=Te[e].value;return Ae(e),t},toWireType:function(e,t){return Ue(t)},argPackAdvance:8,readValueFromPointer:se,Rb:null})},F:function(e,t,n){n=be(n),Se(e,{name:t=ve(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+_e(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Ee(t,n),Rb:null})},j:function(e,n,r,a,i,o){var s=function(e,t){for(var n=[],r=0;r<e;r++)n.push(S[(t>>2)+r]);return n}(n,r);e=ve(e),i=Le(a,i),Be(e,(function(){!function(e,t){var n=[],r={};throw t.forEach((function e(t){r[t]||le[t]||(ce[t]?ce[t].forEach(e):(n.push(t),r[t]=!0))})),new Re(e+": "+n.map(Me).join([", "]))}("Cannot call "+e+" due to unbound types",s)}),n-1),pe([],s,(function(r){var a=e,s=e;r=[r[0],null].concat(r.slice(1));var u=i,l=r.length;2>l&&we("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var c=null!==r[1]&&!1,f=!1,m=1;m<r.length;++m)if(null!==r[m]&&void 0===r[m].Rb){f=!0;break}var d="void"!==r[0].name,h="",p="";for(m=0;m<l-2;++m)h+=(0!==m?", ":"")+"arg"+m,p+=(0!==m?", ":"")+"arg"+m+"Wired";s="return function "+fe(s)+"("+h+") {\nif (arguments.length !== "+(l-2)+") {\nthrowBindingError('function "+s+" called with ' + arguments.length + ' arguments, expected "+(l-2)+" args!');\n}\n",f&&(s+="var destructors = [];\n");var b=f?"destructors":"null";for(h="throwBindingError invoker fn runDestructors retType classParam".split(" "),u=[we,u,o,oe,r[0],r[1]],c&&(s+="var thisWired = classParam.toWireType("+b+", this);\n"),m=0;m<l-2;++m)s+="var arg"+m+"Wired = argType"+m+".toWireType("+b+", arg"+m+"); // "+r[m+2].name+"\n",h.push("argType"+m),u.push(r[m+2]);if(c&&(p="thisWired"+(0<p.length?", ":"")+p),s+=(d?"var rv = ":"")+"invoker(fn"+(0<p.length?", ":"")+p+");\n",f)s+="runDestructors(destructors);\n";else for(m=c?1:2;m<r.length;++m)l=1===m?"thisWired":"arg"+(m-2)+"Wired",null!==r[m].Rb&&(s+=l+"_dtor("+l+"); // "+r[m].name+"\n",h.push(l+"_dtor"),u.push(r[m].Rb));if(d&&(s+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),h.push(s+"}\n"),r=xe(h).apply(null,u),m=n-1,!t.hasOwnProperty(a))throw new he("Replacing nonexistant public symbol");return void 0!==t[a].Qb&&void 0!==m?t[a].Qb[m]=r:(t[a]=r,t[a].$b=m),[]}))},s:function(e,t,n,r,a){function i(e){return e}t=ve(t),-1===a&&(a=4294967295);var o=be(n);if(0===r){var s=32-8*n;i=function(e){return e<<s>>>s}}var u=-1!=t.indexOf("unsigned");Se(e,{name:t,fromWireType:i,toWireType:function(e,n){if("number"!=typeof n&&"boolean"!=typeof n)throw new TypeError('Cannot convert "'+_e(n)+'" to '+this.name);if(n<r||n>a)throw new TypeError('Passing a number "'+_e(n)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+a+"]!");return u?n>>>0:0|n},argPackAdvance:8,readValueFromPointer:Pe(t,o,0!==r),Rb:null})},o:function(e,t,n){function r(e){e>>=2;var t=C;return new a(t.buffer,t[e+1],t[e])}var a=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];Se(e,{name:n=ve(n),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{gc:!0})},E:function(e,t){var n="std::string"===(t=ve(t));Se(e,{name:t,fromWireType:function(e){var t=C[e>>2];if(n){var r=v[e+4+t],a=0;0!=r&&(a=r,v[e+4+t]=0);var i=e+4;for(r=0;r<=t;++r){var o=e+4+r;if(0==v[o]){if(i=E(i),void 0===s)var s=i;else s+=String.fromCharCode(0),s+=i;i=o+1}}0!=a&&(v[e+4+t]=a)}else{for(s=Array(t),r=0;r<t;++r)s[r]=String.fromCharCode(v[e+4+r]);s=s.join("")}return Ft(e),s},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||we("Cannot pass non-string to std::string");var a=(n&&r?function(){return B(t)}:function(){return t.length})(),i=Gt(4+a+1);if(C[i>>2]=a,n&&r)x(t,v,i+4,a+1);else if(r)for(r=0;r<a;++r){var o=t.charCodeAt(r);255<o&&(Ft(i),we("String has UTF-16 code units that do not fit in 8 bits")),v[i+4+r]=o}else for(r=0;r<a;++r)v[i+4+r]=t[r];return null!==e&&e.push(Ft,i),i},argPackAdvance:8,readValueFromPointer:se,Rb:function(e){Ft(e)}})},$:function(e,t,n){if(n=ve(n),2===t)var r=function(){return w},a=1;else 4===t&&(r=function(){return C},a=2);Se(e,{name:n,fromWireType:function(e){for(var t=r(),n=C[e>>2],i=Array(n),o=e+4>>a,s=0;s<n;++s)i[s]=String.fromCharCode(t[o+s]);return Ft(e),i.join("")},toWireType:function(e,n){var i=r(),o=n.length,s=Gt(4+o*t);C[s>>2]=o;for(var u=s+4>>a,l=0;l<o;++l)i[u+l]=n.charCodeAt(l);return null!==e&&e.push(Ft,s),s},argPackAdvance:8,readValueFromPointer:se,Rb:function(e){Ft(e)}})},D:function(e,t,n,r,a,i){ie[e]={name:ve(t),jc:Le(n,r),kc:Le(a,i),Xb:[]}},t:function(e,t,n,r,a,i,o,s,u,l){ie[e].Xb.push({bc:ve(t),ec:n,cc:Le(r,a),dc:i,mc:o,lc:Le(s,u),nc:l})},_:function(e,t){Se(e,{hc:!0,name:t=ve(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(){}})},i:function(e,t,n){e=Fe(e),t=Ge(t,"emval::as");var r=[],a=Ue(r);return S[n>>2]=a,t.toWireType(r,e)},m:function(e,t,n,r){(e=De[e])(t=Fe(t),n=Ie(n),null,r)},c:Ae,l:function(e,t){for(var n=(t=function(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=Ge(S[(t>>2)+r],"parameter "+r);return n}(e,t))[0],r=n.name+"_$"+t.slice(1).map((function(e){return e.name})).join("_")+"$",a=["retType"],i=[n],o="",s=0;s<e-1;++s)o+=(0!==s?", ":"")+"arg"+s,a.push("argType"+s),i.push(t[1+s]);r="return function "+fe("methodCaller_"+r)+"(handle, name, destructors, args) {\n";var u=0;for(s=0;s<e-1;++s)r+="    var arg"+s+" = argType"+s+".readValueFromPointer(args"+(u?"+"+u:"")+");\n",u+=t[s+1].argPackAdvance;for(r+="    var rv = handle[name]("+o+");\n",s=0;s<e-1;++s)t[s+1].deleteObject&&(r+="    argType"+s+".deleteObject(arg"+s+");\n");return n.hc||(r+="    return retType.toWireType(destructors, rv);\n"),a.push(r+"};\n"),function(e){var t=De.length;return De.push(e),t}(e=xe(a).apply(null,i))},g:function(e,t){return Ue((e=Fe(e))[t=Fe(t)])},u:function(e){4<e&&(Te[e].Wb+=1)},r:function(){return Ue([])},e:function(e){return Ue(Ie(e))},q:function(){return Ue({})},h:function(e){oe(Te[e].value),Ae(e)},f:function(e,t,n){e=Fe(e),t=Fe(t),n=Fe(n),e[t]=n},d:function(e,t){return Ue(e=(e=Ge(e,"_emval_take_value")).readValueFromPointer(t))},Y:function(){t.abort()},B:function(e){return K[e]()},X:function(e,t,n,r,a,i,o,s,u,l,c,f){return K[e](t,n,r,a,i,o,s,u,l,c,f)},A:function(e){(e=vt[e])&&e.abort()},W:wt,n:ke,z:function(e,t,n,r,a){!function(e,t,n){At(e,"readonly",(function(e,r){if(e)return n(e);(e=r.get(t)).onsuccess=function(e){return(e=e.target.result)?n(null,e):n("file "+t+" not found")},e.onerror=function(e){n(e)}}))}(E(e),E(t),(function(e,t){e?a&&Ot(a,n):(e=Gt(t.length),v.set(t,e),Nt(r,n,e,t.length),Ft(e))}))},V:function(e,t,n,r,a,i,o){!function(e,t,n,r){At(e,"readwrite",(function(e,a){if(e)return r(e);(e=a.put(n,t)).onsuccess=function(){r()},e.onerror=function(e){r(e)}}))}(E(e),E(t),new Uint8Array(v.subarray(n,n+r)),(function(e){e?o&&Ot(o,a):i&&Ot(i,a)}))},T:function(e,t,n){v.set(v.subarray(t,t+n),e)},S:function(e){if(2147418112<e)return!1;for(var t=Math.max(wt(),16777216);t<e;)t=536870912>=t?L(2*t):Math.min(L((3*t+2147483648)/4),2147418112);return!!function(e){e=L(e);var t=b.byteLength;try{return-1!==c.grow((e-t)/65536)&&(b=c.buffer,!0)}catch(e){return!1}}(t)&&(R(),!0)},R:Ut,Q:function(){Vt("trap!")},P:function(e){!function(){function e(e){return(e=e.toTimeString().match(/\(([A-Za-z ]+)\)$/))?e[1]:"GMT"}if(!St){St=!0,S[Mt()>>2]=60*(new Date).getTimezoneOffset();var t=new Date(2e3,0,1),n=new Date(2e3,6,1);S[Rt()>>2]=Number(t.getTimezoneOffset()!=n.getTimezoneOffset());var r=e(t),a=e(n);r=p(xt(r)),a=p(xt(a)),n.getTimezoneOffset()<t.getTimezoneOffset()?(S[Pt()>>2]=r,S[Pt()+4>>2]=a):(S[Pt()>>2]=a,S[Pt()+4>>2]=r)}}(),e=new Date(1e3*S[e>>2]),S[4244]=e.getSeconds(),S[4245]=e.getMinutes(),S[4246]=e.getHours(),S[4247]=e.getDate(),S[4248]=e.getMonth(),S[4249]=e.getFullYear()-1900,S[4250]=e.getDay();var t=new Date(e.getFullYear(),0,1);S[4251]=(e.getTime()-t.getTime())/864e5|0,S[4253]=-60*e.getTimezoneOffset();var n=new Date(2e3,6,1).getTimezoneOffset();return e=0|(n!=(t=t.getTimezoneOffset())&&e.getTimezoneOffset()==Math.min(t,n)),S[4252]=e,e=S[Pt()+(e?4:0)>>2],S[4254]=e,16976},O:function(e){var t=Date.now()/1e3|0;return e&&(S[e>>2]=t),t},N:function(){Vt("OOM")},a:M,b:16960},b);t.asm=Bt,t._UmbraAssetLoadAbortRequested=function(){return t.asm.ga.apply(null,arguments)},t._UmbraAssetLoadFinish=function(){return t.asm.ha.apply(null,arguments)},t._UmbraAssetLoadGetType=function(){return t.asm.ia.apply(null,arguments)},t._UmbraAssetLoadPrepare=function(){return t.asm.ja.apply(null,arguments)},t._UmbraAssetUnloadFinish=function(){return t.asm.ka.apply(null,arguments)},t._UmbraAssetUnloadGetType=function(){return t.asm.la.apply(null,arguments)},t._UmbraAssetUnloadGetUserPointer=function(){return t.asm.ma.apply(null,arguments)},t._UmbraClientCreate=function(){return t.asm.na.apply(null,arguments)},t._UmbraClientDestroy=function(){return t.asm.oa.apply(null,arguments)},t._UmbraConfigInit=function(){return t.asm.pa.apply(null,arguments)},t._UmbraEcefToGeodetic=function(){return t.asm.qa.apply(null,arguments)},t._UmbraEnvironmentInfoDefaults=function(){return t.asm.ra.apply(null,arguments)},t._UmbraGeodeticToEcef=function(){return t.asm.sa.apply(null,arguments)},t._UmbraGetLibraryInfo=function(){return t.asm.ta.apply(null,arguments)},t._UmbraMaterialLoadGetInfo=function(){return t.asm.ua.apply(null,arguments)},t._UmbraMeshLoadFinishExternal=function(){return t.asm.va.apply(null,arguments)},t._UmbraMeshLoadGetData=function(){return t.asm.wa.apply(null,arguments)},t._UmbraMeshLoadGetInfo=function(){return t.asm.xa.apply(null,arguments)},t._UmbraMeshLoadGetSerializedSize=function(){return t.asm.ya.apply(null,arguments)},t._UmbraMeshLoadSerialize=function(){return t.asm.za.apply(null,arguments)},t._UmbraMeshStreamDone=function(){return t.asm.Aa.apply(null,arguments)},t._UmbraMeshStreamNext=function(){return t.asm.Ba.apply(null,arguments)},t._UmbraMeshStreamSetBuffers=function(){return t.asm.Ca.apply(null,arguments)},t._UmbraRuntimeCreate=function(){return t.asm.Da.apply(null,arguments)},t._UmbraRuntimeDestroy=function(){return t.asm.Ea.apply(null,arguments)},t._UmbraRuntimeGetStreamingState=function(){return t.asm.Fa.apply(null,arguments)},t._UmbraRuntimeNextAssetLoad=function(){return t.asm.Ga.apply(null,arguments)},t._UmbraRuntimeNextAssetUnload=function(){return t.asm.Ha.apply(null,arguments)},t._UmbraRuntimeUpdate=function(){return t.asm.Ia.apply(null,arguments)},t._UmbraSceneCopyCreate=function(){return t.asm.Ja.apply(null,arguments)},t._UmbraSceneCopyDestroy=function(){return t.asm.Ka.apply(null,arguments)},t._UmbraSceneCopyGetError=function(){return t.asm.La.apply(null,arguments)},t._UmbraSceneCopyGetStatus=function(){return t.asm.Ma.apply(null,arguments)},t._UmbraSceneCreate=function(){return t.asm.Na.apply(null,arguments)},t._UmbraSceneCreateLocal=function(){return t.asm.Oa.apply(null,arguments)},t._UmbraSceneCreatePublic=function(){return t.asm.Pa.apply(null,arguments)},t._UmbraSceneDestroy=function(){return t.asm.Qa.apply(null,arguments)},t._UmbraSceneGetConnectionStatus=function(){return t.asm.Ra.apply(null,arguments)},t._UmbraSceneGetInfo=function(){return t.asm.Sa.apply(null,arguments)},t._UmbraSceneSetTransform=function(){return t.asm.Ta.apply(null,arguments)},t._UmbraSetAllocator=function(){return t.asm.Ua.apply(null,arguments)},t._UmbraSetHttp=function(){return t.asm.Va.apply(null,arguments)},t._UmbraSetLogger=function(){return t.asm.Wa.apply(null,arguments)},t._UmbraTextureGetMipmapLevelByteSize=function(){return t.asm.Xa.apply(null,arguments)},t._UmbraTextureGetMipmapLevelOffset=function(){return t.asm.Ya.apply(null,arguments)},t._UmbraTextureLoadGetData=function(){return t.asm.Za.apply(null,arguments)},t._UmbraTextureLoadGetInfo=function(){return t.asm._a.apply(null,arguments)},t._UmbraTextureLoadGetSerializedSize=function(){return t.asm.$a.apply(null,arguments)},t._UmbraTextureLoadSerialize=function(){return t.asm.ab.apply(null,arguments)},t._UmbraTextureMetaDataGetClassification=function(){return t.asm.bb.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationAmount=function(){return t.asm.cb.apply(null,arguments)},t._UmbraTextureMetaDataGetClassificationCount=function(){return t.asm.db.apply(null,arguments)},t._UmbraTextureMetaDataLoadGetData=function(){return t.asm.eb.apply(null,arguments)},t._UmbraVertexAttributeGetElementByteSize=function(){return t.asm.fb.apply(null,arguments)},t._UmbraViewCreate=function(){return t.asm.gb.apply(null,arguments)},t._UmbraViewDestroy=function(){return t.asm.hb.apply(null,arguments)},t._UmbraViewGetCompleted=function(){return t.asm.ib.apply(null,arguments)},t._UmbraViewNextRenderables=function(){return t.asm.jb.apply(null,arguments)},t._UmbraViewRayQuery=function(){return t.asm.kb.apply(null,arguments)},t._UmbraViewResetRenderables=function(){return t.asm.lb.apply(null,arguments)},t._UmbraViewUpdateFilter=function(){return t.asm.mb.apply(null,arguments)},t._UmbraViewUpdateRendering=function(){return t.asm.nb.apply(null,arguments)},t.___embind_register_native_and_builtin_types=function(){return t.asm.ob.apply(null,arguments)};var Lt=t.___getTypeName=function(){return t.asm.pb.apply(null,arguments)},Rt=t.__get_daylight=function(){return t.asm.qb.apply(null,arguments)},Mt=t.__get_timezone=function(){return t.asm.rb.apply(null,arguments)},Pt=t.__get_tzname=function(){return t.asm.sb.apply(null,arguments)},Ft=t._free=function(){return t.asm.tb.apply(null,arguments)},Gt=t._malloc=function(){return t.asm.ub.apply(null,arguments)},zt=t.globalCtors=function(){return t.asm.Mb.apply(null,arguments)},It=t.stackAlloc=function(){return t.asm.Nb.apply(null,arguments)},Dt=t.stackRestore=function(){return t.asm.Ob.apply(null,arguments)},kt=t.stackSave=function(){return t.asm.Pb.apply(null,arguments)};t.dynCall_i=function(){return t.asm.vb.apply(null,arguments)},t.dynCall_ii=function(){return t.asm.wb.apply(null,arguments)},t.dynCall_iii=function(){return t.asm.xb.apply(null,arguments)},t.dynCall_iiii=function(){return t.asm.yb.apply(null,arguments)},t.dynCall_iiiii=function(){return t.asm.zb.apply(null,arguments)},t.dynCall_iiiiii=function(){return t.asm.Ab.apply(null,arguments)},t.dynCall_iiiiiiiiii=function(){return t.asm.Bb.apply(null,arguments)},t.dynCall_iiiji=function(){return t.asm.Cb.apply(null,arguments)},t.dynCall_jiji=function(){return t.asm.Db.apply(null,arguments)},t.dynCall_v=function(){return t.asm.Eb.apply(null,arguments)};var Ot=t.dynCall_vi=function(){return t.asm.Fb.apply(null,arguments)};t.dynCall_vii=function(){return t.asm.Gb.apply(null,arguments)};var Nt=t.dynCall_viii=function(){return t.asm.Hb.apply(null,arguments)};function Wt(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function jt(){function e(){if(!t.calledRun&&(t.calledRun=!0,!f)){if(W=!0,G(D),G(k),t.onRuntimeInitialized&&t.onRuntimeInitialized(),t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;){var e=t.postRun.shift();N.unshift(e)}G(N)}}if(!(0<V)){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)j();G(I),0<V||t.calledRun||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),e()}),1)):e())}}function Vt(e){throw t.onAbort&&t.onAbort(e),i(e),o(e),f=!0,"abort("+e+"). Build with -s ASSERTIONS=1 for more info."}if(t.dynCall_viiii=function(){return t.asm.Ib.apply(null,arguments)},t.dynCall_viiiii=function(){return t.asm.Jb.apply(null,arguments)},t.dynCall_viiiiii=function(){return t.asm.Kb.apply(null,arguments)},t.dynCall_viiiiiiiii=function(){return t.asm.Lb.apply(null,arguments)},t.asm=Bt,t.cwrap=function(e,t,n,r){var a=(n=n||[]).every((function(e){return"number"===e}));return"string"!==t&&a&&!r?d(e):function(){return h(e,t,n,arguments)}},t.then=function(e){if(t.calledRun)e(t);else{var n=t.onRuntimeInitialized;t.onRuntimeInitialized=function(){n&&n(),e(t)}}return t},Wt.prototype=Error(),Wt.prototype.constructor=Wt,q=function e(){t.calledRun||jt(),t.calledRun||(q=e)},t.run=jt,t.abort=Vt,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);0<t.preInit.length;)t.preInit.pop()();return jt(),t.maxBytesDownloaded=0,t.minBytesDownloaded=0,t.URLsDownloaded=new Set([]),t.wgetRequests=vt,e});!function(e){e[e.ColumnMajor=0]="ColumnMajor",e[e.RowMajor=1]="RowMajor",e[e.Count=2]="Count"}(I||(I={})),function(e){e[e.Diffuse=0]="Diffuse",e[e.Normal=1]="Normal",e[e.Specular=2]="Specular",e[e.MetaIndex=3]="MetaIndex",e[e.Count=4]="Count"}(D||(D={})),function(e){e[e.RGBA32=0]="RGBA32",e[e.RGB24=1]="RGB24",e[e.BC1=2]="BC1",e[e.BC3=3]="BC3",e[e.BC4=4]="BC4",e[e.BC5=5]="BC5",e[e.ETC1_RGB=6]="ETC1_RGB",e[e.RGBA_FLOAT32=7]="RGBA_FLOAT32",e[e.UNC1=8]="UNC1",e[e.JPEG=9]="JPEG",e[e.PNG=10]="PNG",e[e.BMP=11]="BMP",e[e.PSD=12]="PSD",e[e.TGA=13]="TGA",e[e.GIF=14]="GIF",e[e.HDR=15]="HDR",e[e.PIC=16]="PIC",e[e.PNM=17]="PNM",e[e.ASTC_4X4=18]="ASTC_4X4",e[e.ASTC_5X4=19]="ASTC_5X4",e[e.ASTC_5X5=20]="ASTC_5X5",e[e.ASTC_6X5=21]="ASTC_6X5",e[e.ASTC_6X6=22]="ASTC_6X6",e[e.ASTC_8X5=23]="ASTC_8X5",e[e.ASTC_8X6=24]="ASTC_8X6",e[e.ASTC_10X5=25]="ASTC_10X5",e[e.ASTC_10X6=26]="ASTC_10X6",e[e.ASTC_8X8=27]="ASTC_8X8",e[e.ASTC_10X8=28]="ASTC_10X8",e[e.ASTC_10X10=29]="ASTC_10X10",e[e.ASTC_12X10=30]="ASTC_12X10",e[e.ASTC_12X12=31]="ASTC_12X12",e[e.ARGB32=32]="ARGB32",e[e.R8=33]="R8",e[e.PVRTC1_RGB4=34]="PVRTC1_RGB4",e[e.PVRTC1_RGBA4=35]="PVRTC1_RGBA4",e[e.UINT8=36]="UINT8",e[e.UINT16=37]="UINT16",e[e.UINT32=38]="UINT32",e[e.RGB565=39]="RGB565",e[e.RG8=40]="RG8",e[e.RG16F=41]="RG16F",e[e.OPENEXR=42]="OPENEXR",e[e.RGBA_FLOAT16=43]="RGBA_FLOAT16",e[e.RGB_FLOAT16=44]="RGB_FLOAT16",e[e.RGB_FLOAT32=45]="RGB_FLOAT32",e[e.Count=46]="Count"}(k||(k={})),function(e){e[e.Linear=0]="Linear",e[e.SRGB=1]="SRGB",e[e.Count=2]="Count"}(O||(O={})),function(e){e[e.Position=0]="Position",e[e.TextureCoordinate=1]="TextureCoordinate",e[e.Normal=2]="Normal",e[e.Tangent=3]="Tangent",e[e.Count=4]="Count"}(N||(N={})),function(e){e[e.UncachedMemory=1]="UncachedMemory"}(W||(W={})),function(e){e[e.Debug=0]="Debug",e[e.Info=1]="Info",e[e.Warning=2]="Warning",e[e.Error=3]="Error",e[e.Count=4]="Count"}(j||(j={})),function(e){e[e.Inactive=0]="Inactive",e[e.Active=1]="Active",e[e.Complete=2]="Complete",e[e.Error=3]="Error",e[e.Count=4]="Count"}(V||(V={})),function(e){e[e.Found=0]="Found",e[e.Not_Found=1]="Not_Found",e[e.Transfer_Not_Complete=2]="Transfer_Not_Complete",e[e.Buffer_Too_Small=3]="Buffer_Too_Small",e[e.Count=4]="Count"}(q||(q={})),function(e){e[e.Get=0]="Get",e[e.Post=1]="Post",e[e.Put=2]="Put",e[e.Delete=3]="Delete",e[e.Count=4]="Count"}(X||(X={})),function(e){e[e.Version=0]="Version",e[e.Copyright=1]="Copyright",e[e.BuildTime=2]="BuildTime",e[e.BuildId=3]="BuildId",e[e.Count=4]="Count"}(H||(H={})),function(e){e[e.InvalidUserPointer=0]="InvalidUserPointer"}(Q||(Q={})),function(e){e[e.None=0]="None",e[e.BC1=1]="BC1",e[e.BC2=2]="BC2",e[e.BC3=4]="BC3",e[e.BC4=8]="BC4",e[e.BC5=16]="BC5",e[e.BC6H=32]="BC6H",e[e.BC7=64]="BC7",e[e.ASTC=128]="ASTC",e[e.ETC1=256]="ETC1",e[e.ETC2=512]="ETC2",e[e.EAC_R=1024]="EAC_R",e[e.EAC_RG=2048]="EAC_RG",e[e.PVRTC1=4096]="PVRTC1",e[e.PVRTC2=8192]="PVRTC2",e[e.ATC=16384]="ATC",e[e.HalfFloat=32768]="HalfFloat",e[e.Float=65536]="Float",e[e.All=2147483647]="All"}(Y||(Y={})),function(e){e[e.NeverUnload=1]="NeverUnload",e[e.ExclusiveRendering=2]="ExclusiveRendering",e[e.EnableRayQueries=4]="EnableRayQueries",e[e.UmbraDebug=-2147483648]="UmbraDebug"}(Z||(Z={})),function(e){e[e.Connected=0]="Connected",e[e.Connecting=1]="Connecting",e[e.ConnectionError=2]="ConnectionError",e[e.Count=3]="Count"}(K||(K={})),function(e){e[e.ZeroToOne=0]="ZeroToOne",e[e.MinusOneToOne=1]="MinusOneToOne",e[e.Count=2]="Count"}(J||(J={})),function(e){e[e.Sphere=0]="Sphere",e[e.Cylinder=1]="Cylinder",e[e.Count=2]="Count"}($||($={})),function(e){e[e.InProgress=0]="InProgress",e[e.Done=1]="Done",e[e.Error=2]="Error",e[e.Count=3]="Count"}(ee||(ee={})),function(e){e[e.File=0]="File",e[e.Directory=1]="Directory",e[e.Cloud=2]="Cloud",e[e.FormatObj=3]="FormatObj",e[e.Count=4]="Count"}(te||(te={})),function(e){e[e.Directory=0]="Directory",e[e.Cloud=1]="Cloud",e[e.Count=2]="Count"}(ne||(ne={})),function(e){e[e.Material=0]="Material",e[e.Texture=1]="Texture",e[e.Mesh=2]="Mesh",e[e.Count=3]="Count"}(re||(re={})),function(e){e[e.Failure=0]="Failure",e[e.OutOfMemory=1]="OutOfMemory",e[e.Aborted=2]="Aborted",e[e.Success=3]="Success",e[e.Count=4]="Count"}(ae||(ae={})),function(e){e[e.BackfaceCulling=1]="BackfaceCulling"}(ie||(ie={}));var se=Object.freeze({get AssetType(){return re},get AssetLoadResult(){return ae}}),ue=new Map([[Float32Array,"HEAPF32"],[Uint32Array,"HEAPU32"],[Uint16Array,"HEAPU16"],[Uint8Array,"HEAPU8"]]);function le(e){if(!Number.isInteger(e))throw new Error("Value was not integer: "+e.toString())}var ce=function(e){class t{constructor(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Float32Array;if(this.ofs=void 0,this.size=void 0,this.type=void 0,le(t/n.BYTES_PER_ELEMENT),0===t)throw new Error("Buffer size was zero");if(this.ofs=e._malloc(t),0===this.ofs)throw new Error("Allocation of ".concat(t," bytes failed."));this.size=t,this.type=n}destroy(){e._free(this.ofs),this.ofs=0,this.size=0}ensureSize(t){if(this.size<t){if(this.destroy(),this.ofs=e._malloc(t),0===this.ofs)throw new Error("Buffer growth to ".concat(t," bytes failed."));this.size=t}}floats(){return new Float32Array(e.HEAPF32.buffer,this.ofs,this.size/4)}bytes(){return new Uint8Array(e.HEAPU8.buffer,this.ofs,this.size)}}class n{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.size,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.type;this.ofs=void 0,this.start=void 0,this.size=void 0,this.type=void 0,this.heapName=void 0,this.ofs=e.ofs,this.start=t,this.size=n,this.type=r,this.heapName=ue.get(r)}getArray(){return new this.type(e[this.heapName].buffer,this.ofs+this.start,this.size/this.type.BYTES_PER_ELEMENT)}}var r=e.getRenderableMemberOffsets();new t(24);function a(e,t){for(var n=0;n<16;n++)e[n]=t[n]}class i{constructor(){this.ptr=void 0,this.configPtr=void 0,this.configPtr=e._malloc(e.CONFIG_SIZE),e.configInit(this.configPtr),this.ptr=e.clientCreate("UmbraJS",this.configPtr)}destroy(){e.clientDestroy(this.ptr),e._free(this.configPtr),this.ptr=0}}class o{constructor(n){this.ptr=void 0,this.matrixBuffer=new t(64),this.infoBuffer=new t(e.sceneInfoSize),this.ptr=n}destroy(){this.matrixBuffer.destroy(),e.sceneDestroy(this.ptr)}connectionStatus(){return e.sceneGetConnectionStatus(this.ptr)}getInfo(){return e.sceneGetInfo(this.ptr,this.infoBuffer.ofs),e.deserializeSceneInfo(this.infoBuffer.ofs)}isConnected(){return this.connectionStatus()===K.Connected}setTransform(t){if(!Array.isArray(t))throw new TypeError("Matrix should be an array");if(16!==t.length)throw new TypeError("Matrix should be of size 4x4");a(this.matrixBuffer.floats(),t),e.sceneSetTransform(this.ptr,this.matrixBuffer.ofs)}}class s{constructor(e,n){this.ptr=void 0,this.matrixBuffer=void 0,this.vectorBuffer=void 0,this.lightBuffer=void 0,this.temp=void 0,this.runtimeAssets=void 0,this.ptr=e,this.matrixBuffer=new t(64),this.vectorBuffer=new t(16),this.lightBuffer=new t(384),this.temp=void 0,this.runtimeAssets=n}destroy(){this.matrixBuffer.destroy(),this.vectorBuffer.destroy(),this.lightBuffer.destroy(),this.temp&&this.temp.destroy(),e.viewDestroy(this.ptr)}setCamera(t,n,r){var i,o,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:J.MinusOneToOne,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:I.ColumnMajor;if(!Array.isArray(t))throw new TypeError("Camera matrix should be an array");if(!Array.isArray(n))throw new TypeError("Position should be an array");if("number"!=typeof r)throw new TypeError("Quality should be a number");if(16!==t.length)throw new TypeError("WorldToClip matrix should be of size 4x4");if(3!==n.length)throw new TypeError("Position vector should be of length 3");if(a(this.matrixBuffer.floats(),t),i=this.vectorBuffer.floats(),o=n,i[0]=o[0],i[1]=o[1],i[2]=o[2],s){if(s.length>32)throw new Error("Too many lights given");for(var c=this.lightBuffer.floats(),f=0;f<s.length;f++)c[3*f+0]=s[f][0],c[3*f+1]=s[f][1],c[3*f+2]=s[f][2]}e.viewUpdateRendering(this.ptr,this.matrixBuffer.ofs,this.vectorBuffer.ofs,u,l,r,this.lightBuffer.ofs,s.length)}getVisible(n){le(n);var a=n*e.renderableSize;(!this.temp||this.temp.size<a)&&(this.temp&&this.temp.destroy(),this.temp=new t(a));var i=this.temp,o=e.renderableSize/4,s=a/4;le(o),le(s);for(var u=function(e,t,n,r){return le(r/4),new e(t.buffer,n+r,s-r/4)},l=u(Uint32Array,e.HEAPU32,i.ofs,r.mesh),c=u(Int32Array,e.HEAP32,i.ofs,r.lodLevel),f=u(Uint32Array,e.HEAPU32,i.ofs,r.visibilityMask),m=u(Uint32Array,e.HEAPU32,i.ofs,r.scene),d=e.viewNextRenderables(this.ptr,i.ofs,n),h=[],p=0;p<d;p++){var b=l[o*p],y=c[o*p],v=f[o*p],g=m[o*p];h.push({id:b,mesh:this.runtimeAssets.get(b),lod:y,mask:v,scenePtr:g})}return h}}class u{constructor(t){this.ptr=void 0,this.assetType=void 0,this.type=void 0,this.data=void 0,this.ptr=t,this.assetType=e.assetLoadGetType(this.ptr),this.type="Load"+re[this.assetType],this.data={}}prepare(t){e.assetLoadPrepare(this.ptr,t)}finish(t){e.assetLoadFinish(this.ptr,t)}}class l{constructor(t){this.ptr=void 0,this.assetType=void 0,this.type=void 0,this.data=void 0,this.ptr=t,this.assetType=e.assetUnloadGetType(this.ptr),this.type="Unload"+re[this.assetType]}finish(){e.assetUnloadFinish(this.ptr)}get userPointer(){return e.assetUnloadGetUserPointer(this.ptr)}}var c=new Map([["position",new t(4)],["normal",new t(4)],["uv",new t(4)],["tangent",new t(4)],["index",new t(4)]]);class f{constructor(t){this.load=void 0,this.info=void 0,this.vertexBuffers=void 0,this.load=t,e.meshLoadGetInfo(this.load.ptr,f.meshInfoBuffer.ofs),this.info=e.deserializeMeshInfo(f.meshInfoBuffer.ofs)}setBuffers(t){if(f.structBuffer.bytes().fill(0),f.tempDataBuffer.bytes().fill(0),e.serializeElementBuffer(t.position.desc,f.structBuffer.ofs),e.serializeElementBuffer(t.index.desc,f.tempDataBuffer.ofs),"uv"in t&&e.serializeElementBuffer(t.uv.desc,f.structBuffer.ofs+1*e.elementBufferSize),"normal"in t&&e.serializeElementBuffer(t.normal.desc,f.structBuffer.ofs+2*e.elementBufferSize),"tangent"in t&&e.serializeElementBuffer(t.tangent.desc,f.structBuffer.ofs+3*e.elementBufferSize),!e.meshStreamSetBuffers(this.load.ptr,f.structBuffer.ofs,f.tempDataBuffer.ofs))throw console.log(t),new Error("setBuffers failed")}loadNext(){return e.meshStreamNext(this.load.ptr,0,0)}done(){return e.meshStreamDone(this.load.ptr)}allocateBuffers(){var r=this,a=this.info.numUniqueVertices<65536?2:4,i={position:{elemSize:e.vertexAttributeGetElementByteSize(N.Position),count:this.info.numUniqueVertices,mask:1<<N.Position,type:Float32Array},uv:{elemSize:e.vertexAttributeGetElementByteSize(N.TextureCoordinate),count:this.info.numUniqueVertices,mask:1<<N.TextureCoordinate,type:Float32Array},normal:{elemSize:e.vertexAttributeGetElementByteSize(N.Normal),count:this.info.numUniqueVertices,mask:1<<N.Normal,type:Float32Array},tangent:{elemSize:e.vertexAttributeGetElementByteSize(N.Tangent),count:this.info.numUniqueVertices,mask:1<<N.Tangent,type:Float32Array},index:{elemSize:a,count:this.info.numIndices,mask:4294967295,type:2===a?Uint16Array:Uint32Array}},o={};Object.keys(i).forEach((function(e){var t=i[e].count*i[e].elemSize;le(t/i[e].type.BYTES_PER_ELEMENT),o[e]=t}));var s={};return Object.keys(i).forEach((function(e){if(r.info.attributes&i[e].mask){var a=function(e,n,r){var a=c.get(e);return a.size<n?(a.size>0&&a.destroy(),a=new t(n,r),c.set(e,a)):r&&(a.type=r),a}(e,o[e],i[e].type),u={};u.ptr=a.ofs,u.elementByteSize=i[e].elemSize,u.elementCapacity=i[e].count,u.elementStride=i[e].elemSize,u.flags=0,s[e]={data:new n(a,0,o[e]),desc:u}}})),s}}f.structBuffer=new t(e.elementBufferSize*N.Count,Uint8Array),f.meshInfoBuffer=new t(e.meshInfoSize,Uint8Array),f.tempDataBuffer=new t(e.elementBufferSize,Uint8Array);class m{constructor(n,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.assets=new Map,this.client=void 0,this.ptr=void 0,this.platformFeatures=void 0,this.nextId=1,this.loader=void 0,this.tempTextureBuffer=new t(1048576,Uint8Array),this.tempTranscodedBuffer=new t(4,Uint8Array),this.tempStreamingStateBuffer=new t(e.streamingStateSize,Uint8Array),this.scratch=void 0,this.debug=void 0;var i=Y.ETC1|Y.ASTC|Y.PVRTC1|Y.BC5,o=r.textureSupportMask;o&i||(o|=Y.BC5|Y.BC4),this.client=n;var s=e.serializeEnvironmentInfo({textureSupportFlags:o,localCacheDirectory:null,localCacheMaximumByteSize:0},0);this.ptr=e.runtimeCreate(n.ptr,s,a),e._free(s),this.platformFeatures=r;var u=Math.max(e.meshInfoSize,e.materialInfoSize,e.textureInfoSize,e.byteBufferSize);this.scratch=new t(u,Uint8Array),this.debug={textureFormatsInUse:new Set,platformFeatures:r}}destroy(){this.tempTextureBuffer.destroy(),this.scratch.destroy(),e.runtimeDestroy(this.ptr),this.client.destroy(),this.ptr=0}createScenePublic(t){var n=e.sceneCreatePublic(this.ptr,t);if(n)return new o(n)}createSceneLocal(t){var n=e.sceneCreateLocal(this.ptr,t);if(n)return new o(n)}createView(){var t=e.viewCreate(this.ptr);return new s(t,this.assets)}update(){e.runtimeUpdate(this.ptr)}*getAssetUnloads(){for(var t=e.runtimeNextAssetUnload(this.ptr);0!==t;){var n=new l(t);n.data=this.assets.get(n.userPointer),yield n,t=e.runtimeNextAssetUnload(this.ptr)}}*getAssetLoads(){for(var t=this;;){if(this.loader){if(!this.loader.done()){if(!this.loader.loadNext())throw new Error("loadNext failed");yield;continue}var r=this.loader.load;r.data.buffers=this.loader.vertexBuffers,r.data.material=this.assets.get(this.loader.info.material),r.data.bounds=[this.loader.info.bounds.mn,this.loader.info.bounds.mx],this.loader=void 0,yield r}var a=e.runtimeNextAssetLoad(this.ptr);if(0===a)return;var i=new u(a);if("LoadMaterial"===i.type){e.materialLoadGetInfo(i.ptr,this.scratch.ofs);var o=e.deserializeMaterialInfo(this.scratch.ofs),s=o.textures.filter((function(t){return t!==e.INVALID_USERPOINTER}));s=s.map((function(e){return t.assets.get(e)})),i.data={transparent:o.transparent,textures:s},yield i}else if("LoadTexture"===i.type){var l=this.scratch.ofs;e.textureLoadGetInfo(i.ptr,l);var c=e.deserializeTextureInfo(l);c.mipByteSizes=[e.textureGetMipmapLevelByteSize(l,0)],c.mipByteOffsets=[e.textureGetMipmapLevelOffset(l,0)];var m=this.tempTextureBuffer;if(m.ensureSize(c.dataByteSize),e.serializeByteBuffer({ptr:m.ofs,byteSize:c.dataByteSize,flags:0},this.scratch.ofs),!e.textureLoadGetData(i.ptr,this.scratch.ofs))throw new Error("textureLoadGetData failed: ".concat(i.ptr,", ").concat(m.ofs,", ").concat(c.dataByteSize,"/").concat(m.size));var d=new n(m,0,c.dataByteSize);if(this.formatNeedsTranscoding(c.format)){var h;c=this.downsampleAndTranscodeTexture(c,m,this.tempTranscodedBuffer);var p=(F(h={},k.RGBA32,Uint8Array),F(h,k.RGB565,Uint16Array),F(h,k.RG8,Uint8Array),F(h,k.RG16F,Uint16Array),h);(d=new n(this.tempTranscodedBuffer,0,c.dataByteSize)).type=p[c.format]}this.debug.textureFormatsInUse.add(c.format),i.data={info:c,buffer:d},yield i}else{if("LoadMesh"!==i.type)throw new Error("Job wasn't handled correctly");this.loader=new f(i),this.loader.vertexBuffers=this.loader.allocateBuffers(),this.loader.setBuffers(this.loader.vertexBuffers),yield}}}loadAssets(e,t){var n=performance.now();for(var r of this.getAssetUnloads())if(e[r.type](r),performance.now()-n>t)break;for(var a of this.getAssetLoads()){if(a)try{e[a.type](a)}catch(e){throw a.finish(ae.Failure),e}if(performance.now()-n>t)break}}addAsset(e){var t=this.nextId;return this.nextId=this.nextId+1|0,0===this.nextId&&(this.nextId=1),this.assets.set(t,e),t}removeAsset(e,t){var n=e.userPointer;return this.assets.has(n)&&this.assets.delete(n),n}formatNeedsTranscoding(e){var t=this.platformFeatures.textureSupportMask;switch(e){case k.BC1:if(t&Y.BC1)return!1;break;case k.BC3:if(t&Y.BC3)return!1;break;case k.BC4:if(t&Y.BC4)return!1;break;case k.BC5:if(t&Y.BC5)return!1;break;default:return!1}return!0}downsampleAndTranscodeTexture(t,n,r){var a=e.getUncompressedFromBCFormat(t.format);if(a===k.Count)throw new Error("Couldn't find a matching BC format");a!==k.RG16F||this.platformFeatures.halfFloat||(a=k.RG8);var i=e.getTextureByteSize(t.width,t.height,a);r.ensureSize(i);var o=e.downsampleAndTranscodeTexture(t.format,a,t.width,t.height,n.ofs,t.dataByteSize,r.ofs,r.size);if(!o.success)throw new Error("Texture transcoding failed. Input: ".concat(t.format,", output: ").concat(a,", output size: ").concat(i));if(o.texture.format!==a)throw new Error("Transcoded texture format was ".concat(o.texture.format," instead of the expected ").concat(a));var s=Object.assign({},t),u=o.texture;return s=Object.assign(s,{format:u.format,width:u.width,height:u.height,dataByteSize:u.dataByteSize,mipByteSizes:[u.dataByteSize]})}getStreamingState(){return e.runtimeGetStreamingState(this.ptr,this.tempStreamingStateBuffer.ofs),e.deserializeStreamingState(this.tempStreamingStateBuffer.ofs)}getStreamingProgress(){var e=this.getStreamingState();return 0==e.numResidentTiles?0:e.numResidentTilesLoaded/e.numResidentTiles}}return{createRuntime:function(e){return new m(new i,e)}}};var fe,me=function(e){return e=Object.assign({wasmURL:""},e),new Promise((function(t,n){try{oe({locateFile:function(t,n){return t.endsWith("umbra.wasm")&&""!==e.wasmURL?e.wasmURL:n+t}}).then((function(e){delete e.then,e.onAbort=function(e){n(e)},function(e){Object.assign(e,{configInit:e.cwrap("UmbraConfigInit",null,["number"]),clientCreate:e.cwrap("UmbraClientCreate","number",["string","number"]),clientDestroy:e.cwrap("UmbraClientDestroy",null,["number"]),getLibraryInfo:e.cwrap("UmbraGetLibraryInfo","string",["number"]),environmentInfoDefaults:e.cwrap("UmbraEnvironmentInfoDefaults",null,["number"]),runtimeCreate:e.cwrap("UmbraRuntimeCreate","number",["number","number","number"]),runtimeUpdate:e.cwrap("UmbraRuntimeUpdate",null,["number"]),runtimeGetStreamingState:e.cwrap("UmbraRuntimeGetStreamingState",null,["number","number"]),runtimeDestroy:e.cwrap("UmbraRuntimeDestroy",null,["number"]),sceneCreate:e.cwrap("UmbraSceneCreate","number",["number","string","string"]),sceneCreatePublic:e.cwrap("UmbraSceneCreatePublic","number",["number","string"]),sceneCreateLocal:e.cwrap("UmbraSceneCreateLocal","number",["number","string"]),sceneGetConnectionStatus:e.cwrap("UmbraSceneGetConnectionStatus","number",["number"]),sceneGetInfo:e.cwrap("UmbraSceneGetInfo","number",["number","number"]),sceneSetTransform:e.cwrap("UmbraSceneSetTransform",null,["number","number"]),sceneDestroy:e.cwrap("UmbraSceneDestroy",null,["number"]),viewCreate:e.cwrap("UmbraViewCreate","number",["number"]),viewUpdateRendering:e.cwrap("UmbraViewUpdateRendering",null,["number","number","number","number","number","number","number","number"]),viewUpdateFilter:e.cwrap("UmbraViewUpdateFilter",null,["number","number"]),viewGetCompleted:e.cwrap("UmbraViewGetCompleted","number",["number"]),viewNextRenderables:e.cwrap("UmbraViewNextRenderables","number",["number","number","number"]),viewResetRenderables:e.cwrap("UmbraViewResetRenderables",null,["number"]),viewDestroy:e.cwrap("UmbraViewDestroy",null,["number"]),viewRayQuery:e.cwrap("UmbraViewRayQuery","number",["number","number","number","number","number","number"]),sceneCopyCreate:e.cwrap("UmbraSceneCopyCreate","number",["number","number","number","number","number"]),sceneCopyGetStatus:e.cwrap("UmbraSceneCopyGetStatus","number",["number","number"]),sceneCopyGetError:e.cwrap("UmbraSceneCopyGetError","string",["number"]),sceneCopyDestroy:e.cwrap("UmbraSceneCopyDestroy",null,["number"]),vertexAttributeGetElementByteSize:e.cwrap("UmbraVertexAttributeGetElementByteSize","number",["number"]),runtimeNextAssetLoad:e.cwrap("UmbraRuntimeNextAssetLoad","number",["number"]),assetLoadGetType:e.cwrap("UmbraAssetLoadGetType","number",["number"]),assetLoadPrepare:e.cwrap("UmbraAssetLoadPrepare",null,["number","number"]),assetLoadAbortRequested:e.cwrap("UmbraAssetLoadAbortRequested","number",["number"]),assetLoadFinish:e.cwrap("UmbraAssetLoadFinish",null,["number","number"]),meshLoadFinishExternal:e.cwrap("UmbraMeshLoadFinishExternal",null,["number","number","number","number"]),meshLoadGetInfo:e.cwrap("UmbraMeshLoadGetInfo",null,["number","number"]),meshLoadGetData:e.cwrap("UmbraMeshLoadGetData","number",["number","number","number"]),meshStreamSetBuffers:e.cwrap("UmbraMeshStreamSetBuffers","number",["number","number","number"]),meshStreamDone:e.cwrap("UmbraMeshStreamDone","number",["number"]),meshStreamNext:e.cwrap("UmbraMeshStreamNext","number",["number","number","number"]),meshLoadGetSerializedSize:e.cwrap("UmbraMeshLoadGetSerializedSize","number",["number"]),textureGetMipmapLevelByteSize:e.cwrap("UmbraTextureGetMipmapLevelByteSize","number",["number","number"]),textureGetMipmapLevelOffset:e.cwrap("UmbraTextureGetMipmapLevelOffset","number",["number","number"]),textureLoadGetInfo:e.cwrap("UmbraTextureLoadGetInfo",null,["number","number"]),textureLoadGetData:e.cwrap("UmbraTextureLoadGetData","number",["number","number"]),textureLoadGetSerializedSize:e.cwrap("UmbraTextureLoadGetSerializedSize","number",["number"]),textureMetaDataLoadGetData:e.cwrap("UmbraTextureMetaDataLoadGetData","number",["number","number"]),textureMetaDataGetClassificationCount:e.cwrap("UmbraTextureMetaDataGetClassificationCount","number",["number","number"]),textureMetaDataGetClassification:e.cwrap("UmbraTextureMetaDataGetClassification","number",["number","number","number"]),textureMetaDataGetClassificationAmount:e.cwrap("UmbraTextureMetaDataGetClassificationAmount","number",["number","number","number"]),materialLoadGetInfo:e.cwrap("UmbraMaterialLoadGetInfo",null,["number","number"]),runtimeNextAssetUnload:e.cwrap("UmbraRuntimeNextAssetUnload","number",["number"]),assetUnloadGetType:e.cwrap("UmbraAssetUnloadGetType","number",["number"]),assetUnloadGetUserPointer:e.cwrap("UmbraAssetUnloadGetUserPointer","number",["number"]),assetUnloadFinish:e.cwrap("UmbraAssetUnloadFinish",null,["number"])})}(e),t(function(e){var t={getPlatformFeatures:function(e){var t=0,n=new Set,r=!1,a=!1,i=new Map([]),o=[],s=e.getSupportedExtensions();for(var u of s){var l=u.replace(/^(.*)_WEBGL_/,"WEBGL_");i.set(l,u),o.push(l)}var c=new Map([["WEBGL_compressed_texture_s3tc",{mask:Y.BC1|Y.BC2|Y.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_s3tc_srgb",{mask:Y.BC1|Y.BC2|Y.BC3,names:["bc1","bc2","bc3"]}],["WEBGL_compressed_texture_rgtc",{mask:Y.BC4|Y.BC5,names:["bc4","bc5"]}],["WEBGL_compressed_texture_pvrtc",{mask:Y.PVRTC1,names:["pvrtc1_rgb4","pvrtc1_rgba4"]}],["WEBGL_compressed_texture_etc1",{mask:Y.ETC1,names:["etc1_rgb"]}],["WEBGL_compressed_texture_astc",{mask:Y.ASTC,names:["astc_4x4"]}]]);for(var f of c.keys())if(o.includes(f)){e.getExtension(i.get(f));var m=c.get(f);t|=m.mask,m.names.forEach((function(e){return n.add(e)}))}return o.includes("WEBGL_compressed_texture_s3tc_srgb")&&(r=!0),o.includes("EXT_sRGB")&&(e.getExtension(i.get("EXT_sRGB")),r=!0),o.includes("OES_texture_half_float")&&(e.getExtension(i.get("OES_texture_half_float")),a=!0),{textureSupportMask:t,formats:G(n),srgb:r,halfFloat:a}}};return t.nativeModule=e,t.createRuntime=ce(e).createRuntime,t.getStreamingInfo=function(){return{minBytesDownloaded:t.nativeModule.minBytesDownloaded,maxBytesDownloaded:t.nativeModule.maxBytesDownloaded}},t.getLibraryInfo=function(){return{version:e.getLibraryInfo(H.Version),copyright:e.getLibraryInfo(H.Copyright),buildTime:e.getLibraryInfo(H.BuildTime),buildID:e.getLibraryInfo(H.BuildId)}},t.abortDownloads=function(){Object.values(e.wgetRequests).forEach((function(e){e.abort()}))},t}(e))}))}catch(e){n(e)}}))};function de(e,t,n){return{format:e,type:t,compressed:n}}var he=(x(fe={},k.RGB24,de(r,e,!1)),x(fe,k.RGBA32,de(t,e,!1)),x(fe,k.RGB565,de(r,n,!1)),x(fe,k.RG8,de(a,e,!1)),x(fe,k.RG16F,de(a,i,!1)),x(fe,k.BC1,de(o,e,!0)),x(fe,k.BC3,de(s,e,!0)),x(fe,k.ETC1_RGB,de(u,e,!0)),x(fe,k.ASTC_4X4,de(l,e,!0)),x(fe,k.PVRTC1_RGB4,de(c,e,!0)),fe);class pe{constructor(e){this.flipTangent=void 0,this.defines=void 0,this.flipTangent=!1,this.defines="",e.indexOf("bc3")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC3\n"),e.indexOf("bc5")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_BC5\n"),e.indexOf("astc_4x4")>-1&&(this.defines+="#define UMBRA_TEXTURE_SUPPORT_ASTC\n")}process(e,t){var n=e.fragmentShader;this.flipTangent&&(n="#define UMBRA_FLIP_TANGENT\n"+n),n=(n=(n=(n=this.defines+n).replace("#include <normal_fragment_maps>","\n#ifdef USE_NORMALMAP\n#ifdef USE_TANGENT\n\nvec3 tangentToWorld2 = normal;\nvec3 tangentToWorld0 = normalize(tangent - tangentToWorld2 * dot(tangentToWorld2, tangent));\n\n#ifdef UMBRA_FLIP_TANGENT\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld0, tangentToWorld2));\n#else\nvec3 tangentToWorld1 = normalize(cross(tangentToWorld2, tangentToWorld0));\n#endif\n\n#if defined(UMBRA_TEXTURE_SUPPORT_BC5) || defined(UMBRA_TEXTURE_SUPPORT_ASTC)\nnormal.xy = texture2D(normalMap, vUv).xy * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#elif defined(UMBRA_TEXTURE_SUPPORT_BC3)\nnormal.xy = texture2D(normalMap, vUv).yw * 2.0 - 1.0;\nnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n#else\nnormal.xyz = texture2D(normalMap, vUv).xyz;\nnormal.xy *= 2.0;\nnormal.xy -= 1.0;\nnormal = normalize(normal);\n#endif\n\nnormal = tangentToWorld0 * normal.x + tangentToWorld1 * normal.y + tangentToWorld2 * normal.z;\nnormal = normalize(normal);\n#endif\n#endif\n\n")).replace("#include <metalnessmap_fragment>","\nfloat metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness = texture2D( metalnessMap, vUv );\nmetalnessFactor *= texelMetalness.r;\n#endif\n")).replace("#include <roughnessmap_fragment>","\nfloat roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness = texture2D( roughnessMap, vUv );\nfloat roughness = 1.0 - texelRoughness.g;\nroughnessFactor *= roughness;\n#endif\n"),e.fragmentShader=n}}class be{constructor(){this.usedList=[],this.freeList=[]}allocate(e,t){var n;if(this.freeList.length>0)if(void 0===t)n=this.freeList.pop();else for(var r=0;r<this.freeList.length;r++){var a=this.freeList[r];if(t(a)){n=a,this.freeList.splice(r,1);break}}return n||(n=e()),this.usedList.push(n),n}freeAll(e){for(var t=0;t<this.usedList.length;t++)e&&e(this.usedList[t]),this.freeList.push(this.usedList[t]);this.usedList.length=0}clear(){this.usedList.length=0,this.freeList.length=0}}class ye extends f{set quality(e){console.error("Setting UmbraScene.quality is not supported any more. Set camera.umbraQuality = ".concat(e," instead."))}constructor(e,t,n,r,a){var i,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0;super(),i=this,this.material=new m,this.wireframe=!1,this.freeze=!1,this.onConnected=void 0,this.onConnectionError=void 0,this.onDisconnected=void 0,this.onConnectionChanged=void 0,this.onMeshChanged=void 0,this.isLOD=!0,this.autoUpdate=!0,this.name="UmbraScene",this.renderer=void 0,this.materialPool=new be,this.shaderPatcher=void 0,this.sharedState=void 0,this.stats={numVisible:0,numShadowCasters:0,numCachedMaterials:0,numAssets:0},this.diagnostics={missingNormals:{checked:!1,message:"Property umbraScene.opaqueMaterial has been deprecated. Use umbraScene.material instead."},deprecatedMaterial:{checked:!1,message:"UmbraScene has no normals so it will appear black."},report:function(e){i.diagnostics[e].checked||(i.diagnostics[e].checked=!0,console.warn(i.diagnostics[e].message))}},this.umbra=void 0,this.onDispose=void 0,this.oldState={status:void 0,visibleIDs:new Set},this.update=function(e){var t=this;if(!this.freeze){var n=this.sharedState.cameraToView.get(e);if(n||(n=this.umbra.runtime.createView(),this.sharedState.cameraToView.set(e,n)),this.sharedState.viewLastUseFrame.set(n,this.renderer.info.render.frame),this.umbra.nativeScene.setTransform(this.matrixWorld.elements),this.isPBREnabled()){var r=this.matrixWorld.determinant()<0;r!==this.shaderPatcher.flipTangent&&(this.shaderPatcher.flipTangent=r,this.materialPool.clear())}this.stats.numVisible=0,this.stats.numAssets=this.umbra.runtime.assets.size;for(var a=[],i=0;i<this.children.length;i++)this.children[i].isUmbraMesh||a.push(this.children[i]);this.children=a;var o=[],s=new f;s.isLOD=!0,s.autoUpdate=!0,s.update=function(e){t.children.pop();for(var n=0;n<o.length;n++)t.children.push(o[n])},this.materialPool.freeAll((function(e){delete e.map,delete e.normalMap,delete e.metalnessMap,delete e.roughnessMap}));var u=[],l=new Set;this.sharedState.viewRenderables.has(n)&&(u=this.sharedState.viewRenderables.get(n));for(var c=function(e){if(u[e].scenePtr!==t.umbra.nativeScene.ptr)return"continue";var n=u[e].mesh,r=n.materialDesc,a=n.geometry;l.add(u[e].id),t.stats.numVisible+=1;var i=r.transparent||t.material.transparent,s=t.materialPool.allocate((function(){return t.material.clone()}),(function(e){return e.transparent===i}));s.wireframe=t.wireframe,s.opacity=t.material.opacity,s.transparent=i,s.onBeforeCompile=function(e,n){t.material.onBeforeCompile&&t.material.onBeforeCompile.apply(s,[e,n]),t.shaderPatcher.process(e,n)};var c=r.textures[D.Diffuse],f=r.textures[D.Normal],m=r.textures[D.Specular];c&&c.isTexture&&(s.map=c),f&&f.isTexture&&(s.normalMap=f,s.vertexTangents=!0,s.normalMapType=p),m&&m.isTexture&&(s.metalnessMap=m,s.metalness=1,s.roughnessMap=m,s.roughness=1);var d=new b(a,s);d.isUmbraMesh=!0,d.matrixWorld.copy(t.matrixWorld),d.castShadow=t.castShadow,d.receiveShadow=t.receiveShadow,d.visible=!0,t.children.push(d),0==(1&u[e].mask)?(o.push(d),d.frustumCulled=!0):(t.children.push(d),d.frustumCulled=!1)},m=0;m<u.length;m++)c(m);if(!this.diagnostics.missingNormals.checked&&this.isPBREnabled())for(var d=0;d<this.children.length;d++)if(this.children[d].isUmbraMesh&&!("normal"in this.children[d].geometry.attributes)){this.diagnostics.report("missingNormals");break}this.stats.numShadowCasters=o.length,this.stats.numCachedMaterials=this.materialPool.usedList.length+this.materialPool.freeList.length,o.length>0&&this.children.push(s),this.updateStreamingEvents(l)}},this.renderer=r,this.sharedState=n,this.shaderPatcher=new pe(a.formats),this.onDispose=o,this.scale.set(1,1,-1),this.umbra={runtime:e,nativeScene:t}}get opaqueMaterial(){return this.diagnostics.report("deprecatedMaterial"),this.material}set opaqueMaterial(e){this.diagnostics.report("deprecatedMaterial"),this.material=e}getInfo(){var e={connected:this.umbra.nativeScene.isConnected()};return e.connected&&(e.sceneInfo=this.umbra.nativeScene.getInfo()),Object.assign(e,this.stats),e}getBounds(){if(this.umbra.nativeScene.isConnected()){var e=this.umbra.nativeScene.getInfo().bounds,t=e.mn,n=e.mx;return new d(new h(t[0],t[1],t[2]),new h(n[0],n[1],n[2]))}}getCenter(){var e=this.getBounds();e.applyMatrix4(this.matrixWorld);var t=new h;return e.getCenter(t),t}updateStreamingEvents(e){var t=this.oldState.visibleIDs,n=e;if(this.onMeshChanged)if(t.size!==n.size)this.onMeshChanged();else for(var r of n)if(!t.has(r)){this.onMeshChanged();break}this.oldState.visibleIDs=e}updateNetworkEvents(){var e=this.umbra.nativeScene.connectionStatus();if(this.oldState.status!==e)switch(this.onConnectionChanged&&this.onConnectionChanged(e),e){case K.ConnectionError:this.onConnectionError&&this.onConnectionError("Could not connect");break;case K.Connected:this.onConnected&&this.onConnected();break;case K.Connecting:this.onDisconnected&&this.onDisconnected()}this.oldState.status=e}dispose(){this.onDispose&&this.onDispose(this),this.children=this.children.filter((function(e){return!e.isUmbraMesh})),this.materialPool.freeAll((function(e){return e.dispose()})),this.umbra.nativeScene.destroy()}isPBREnabled(){return"normalMapType"in this.material}}class ve extends y{constructor(e,t){super(t),this.Umbra=void 0,this.Umbra=e}load(e,t,n,r){var a=this.Umbra.createScene(e);r&&(a.onConnectionError=function(e){r(e)}),a.onConnected=function(){delete a.onConnectionError,n&&n(1),t(a)}}}class ge{get memoryUsed(){return this.textureMemoryUsed+this.meshMemoryUsed}constructor(e,t){var n,r=this;this.memoryLimit=524288e3,this.downloadLimit=0,this.qualityFactor=1,this.onStreamingUpdate=void 0,this.onStreamingComplete=void 0,this.umbrajs=void 0,this.runtime=void 0,this.features=void 0,this.renderer=void 0,this.updateTask=void 0,this.assetSizes=new Map,this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.lastQualityLowerFrame=-1,this.umbraScenes=new Set,this.oldState={progress:0,downloadLimitReached:!1},this.sharedState={cameraToView:new Map,viewRenderables:new Map,viewLastUseFrame:new Map},this.tempVector=new h,this.dirVector=new h,this.matrixWorldInverse=new v,this.projScreenMatrix=new v,this.cameraWorldPosition=new h,this.handlers={LoadMaterial:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t=e.data;t.transparent=!!e.data.transparent,e.prepare(r.runtime.addAsset(t)),e.finish(se.AssetLoadResult.Success)})),UnloadMaterial:function(e){r.runtime.removeAsset(e,e.data),e.finish()},LoadTexture:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t,n=e.data.info,a=e.data.buffer;if(he.hasOwnProperty(n.format)&&(t=he[n.format]),!t)return console.log("Unknown texture format",n.format),e.prepare(r.runtime.addAsset({isTexture:!1})),void e.finish(se.AssetLoadResult.Success);if(!r.canFitInMemory(a.size))return e.finish(se.AssetLoadResult.OutOfMemory),void r.adjustQuality(.8);var i=r.makeTexture(n,a,t),o=!1;"outputEncoding"in r.renderer?o=r.renderer.outputEncoding===C:"gammaOutput"in r.renderer&&(o=r.renderer.gammaOutput),n.type!==D.Diffuse||o?i.encoding=n.colorSpace===O.Linear?T:C:i.encoding=T,i.needsUpdate=!0,r.textureMemoryUsed+=a.size,r.assetSizes.set(i,a.size),e.prepare(r.runtime.addAsset(i)),e.finish(se.AssetLoadResult.Success)})),UnloadTexture:function(e){e.data.isTexture&&e.data.dispose(),r.assetSizes.has(e.data)&&(r.textureMemoryUsed-=r.assetSizes.get(e.data),r.assetSizes.delete(e.data)),r.runtime.removeAsset(e,e.data),e.finish()},LoadMesh:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){var t={position:{components:3},normal:{components:3},uv:{components:2},tangent:{components:3}},n=0;if(Object.keys(t).map((function(t){return e.data.buffers[t]})).forEach((function(e){e&&(n+=e.data.size)})),!r.canFitInMemory(n))return e.finish(se.AssetLoadResult.OutOfMemory),void r.adjustQuality(.8);var a,i,o,s,u,l=new A,c=e.data.buffers.index.data.getArray(),f=Array.from(c);l.setIndex(f),l.boundingSphere=(a=e.data.bounds,i=a[0],o=a[1],s=new h(o[0]-i[0],o[1]-i[1],o[2]-i[2]),u=new h(i[0]+.5*s.x,i[1]+.5*s.y,i[2]+.5*s.z),new U(u,s.length())),Object.keys(t).forEach((function(n){var r=e.data.buffers[n];if(r){var a=r.data.getArray(),i=new _(a.slice(),t[n].components);"setAttribute"in l?l.setAttribute(n,i):l.addAttribute(n,i)}}));var m={geometry:l,materialDesc:e.data.material};r.meshMemoryUsed+=n,r.assetSizes.set(m,n),e.prepare(r.runtime.addAsset(m)),e.finish(se.AssetLoadResult.Success)})),UnloadMesh:function(e){var t=e.data;r.assetSizes.has(e.data)&&(r.meshMemoryUsed-=r.assetSizes.get(e.data),r.assetSizes.delete(e.data)),r.runtime.removeAsset(e,t),t.geometry.dispose(),e.finish()}},n="getContext"in t?t.getContext():t.context;var a=e.getPlatformFeatures(n);a.textureSupportMask&=~Y.BC5,this.umbrajs=e,this.runtime=e.createRuntime(a),this.renderer=t,this.features=a,this.startEventUpdate(1e3/60)}startEventUpdate(e){var t=this;this.stopEventUpdate(),this.updateTask=window.setInterval((function(){t.updateEvents(),t.umbraScenes.forEach((function(e){return e.updateNetworkEvents()}))}),e)}stopEventUpdate(){void 0!==this.updateTask&&(window.clearInterval(this.updateTask),delete this.updateTask)}findLights(e){var t;if(e.traverseAncestors((function(e){e.isScene&&(t=e)})),!t||t&&!t.isScene)return new Set;var n=new Set;return t.traverseVisible((function(e){e.isDirectionalLight&&e.castShadow&&n.add(e)})),n}pruneOldViews(e){for(var t of this.sharedState.viewLastUseFrame){var n=B(t,2),r=n[0];if(!(e-n[1]<600)){for(var a of this.sharedState.cameraToView){var i=B(a,2),o=i[0];if(i[1]===r){this.sharedState.cameraToView.delete(o);break}}r.destroy(),this.sharedState.viewLastUseFrame.delete(r)}}}updateViews(){var e=this.sharedState,t=new Set;if(this.renderer.shadowMap.enabled)for(var n of this.umbraScenes)for(var r of this.findLights(n))t.add(r);var a=this.dirVector,i=this.tempVector,o=Array.from(t).map((function(e){return a.setFromMatrixPosition(e.target.matrixWorld),i.setFromMatrixPosition(e.matrixWorld),a.sub(i),[a.x,a.y,a.z]}),t);for(var s of(this.pruneOldViews(this.renderer.info.render.frame),e.cameraToView)){var u=B(s,2),l=u[0],c=u[1],f=l;this.matrixWorldInverse.getInverse(f.matrixWorld),this.projScreenMatrix.multiplyMatrices(f.projectionMatrix,this.matrixWorldInverse),"umbraStreamingPosition"in f?this.cameraWorldPosition.copy(f.umbraStreamingPosition):f.getWorldPosition(this.cameraWorldPosition);var m=.5;"umbraQuality"in f&&(m=f.umbraQuality);var d=this.cameraWorldPosition;c.setCamera(this.projScreenMatrix.elements,[d.x,d.y,d.z],m*this.qualityFactor,o);var h=[];e.viewRenderables.has(c)?(h=e.viewRenderables.get(c)).length=0:e.viewRenderables.set(c,h);var p=[];do{var b;p=c.getVisible(500),(b=h).push.apply(b,L(p))}while(500===p.length)}}update(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=0!==this.downloadLimit&&this.getStats().maxBytesDownloaded>=this.downloadLimit;if(t)this.oldState.downloadLimitReached||this.umbrajs.abortDownloads();else{var n=performance.now();this.runtime.update();var r=performance.now()-n;this.runtime.loadAssets(this.handlers,e-r),this.updateViews()}this.oldState.downloadLimitReached=t,this.memoryUsed/this.memoryLimit<.25&&this.adjustQuality(1.1)}createScene(e){var t,n=this;if("string"==typeof e)t=e;else{if("object"!==E(e))throw new TypeError("expected either string or an object argument");if("token"in e&&(console.warn("Connection with {token, projectID, modelID} is deprecated. Use {key, project, model} or a string locator instad."),e.key=e.token,e.project=e.projectID,e.model=e.modelID),!("key"in e&&"project"in e&&"model"in e))throw new Error('createScene() expects an object with properties "key", "project", and "model"');t="key=".concat(e.key,"&project=").concat(e.project,"&model=").concat(e.model)}var r=new ye(this.runtime,this.runtime.createScenePublic(t),this.sharedState,this.renderer,this.features,(function(e){return n.umbraScenes.delete(e)}));return this.umbraScenes.add(r),r}createSceneWithURL(e){var t=this,n=this.runtime.createSceneLocal(e),r=new ye(this.runtime,n,this.sharedState,this.renderer,this.features,(function(e){return t.umbraScenes.delete(e)}));return this.umbraScenes.add(r),r}getStats(){return Object.assign(this.umbrajs.getStreamingInfo(),{textureMemoryUsed:this.textureMemoryUsed,meshMemoryUsed:this.meshMemoryUsed})}canFitInMemory(e){return this.memoryUsed+e<this.memoryLimit}adjustQuality(e){this.renderer.info.render.frame!=this.lastQualityLowerFrame&&(this.qualityFactor=Math.max(0,Math.min(1,this.qualityFactor*e)),this.lastQualityLowerFrame=this.renderer.info.render.frame)}makeTexture(e,t,n){var r,a=t.getArray().slice();if(n.compressed){var i={width:e.width,height:e.height,data:a};r=new g([i],e.width,e.height)}else r=new w(a,e.width,e.height);return r.format=n.format,r.type=n.type,r.magFilter=S,r.minFilter=S,r.anisotropy=0,r}updateEvents(){var e=this.getStreamingProgress();this.oldState.progress!=e&&(this.onStreamingUpdate&&this.onStreamingUpdate(e),1===e&&this.onStreamingComplete&&this.onStreamingComplete()),this.oldState.progress=e}getStreamingProgress(){return this.runtime.getStreamingProgress()}dispose(){for(var e of(this.stopEventUpdate(),this.sharedState.cameraToView.values()))e.destroy();this.umbraScenes.forEach((function(e){return e.dispose()})),this.sharedState.cameraToView.clear(),this.umbraScenes.clear(),this.runtime.assets.forEach((function(e,t){"geometry"in e&&e.geometry.dispose(),"dispose"in e&&e.dispose()})),this.assetSizes.clear(),this.textureMemoryUsed=0,this.meshMemoryUsed=0,this.runtime.destroy(),this.runtime=void 0,function(e){e.abortDownloads();var t=e;try{t.nativeModule._exit(0)}catch(e){if("ExitStatus"!==e.name)throw e}}(this.umbrajs)}}function we(e,t){if(!e)throw new TypeError('"renderer" should be of type THREE.WebGLRenderer');return me(t).then((function(t){return new ge(t,e)}))}export{ve as Loader,ye as Scene,we as initWithThreeJS};
//# sourceMappingURL=umbrajs-three.esm.min.js.map
